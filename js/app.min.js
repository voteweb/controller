/*!
 * Voteweb Controller 1.0.0
 * https://github.com/voteweb/controller
 * https://www.voteweb.fr
 *
 * Copyright 2022 Voteweb authors
 * @license CC BY-NC-SA 4.0
 * https://creativecommons.org/licenses/by-nc-sa/4.0/
 */
const App=function(){function t(e){this.el=e,this.controlElements=JSON.parse(this.el.querySelector("#control-elements").value),this.getUrl=function(){var e="voteweb.fr";const t=this.controlElements.d;if(-1===t.indexOf(e,t.length-e.length))throw"Domaine incorrect";return"https://"+t+this.path},this.renderHeader=function(e){return'<h3 class="fs-4 text-center">'+e.voteLabel+' <small class="text-muted">'+e.voteSubLabel+'</small></h3><p class="text-center">'+e.electionLabel+(e.ballotTitle?" - "+e.ballotTitle:"")+"</p>"},this.renderFooter=function(){return'<p class="text-center mt-3"><a class="btn btn-outline-secondary" href=""><i class="bi bi-arrow-left-circle-fill"></i> Retour</a></p>'}}function c(e){t.call(this,e),this.path="/ballot-papers/control-integrity",this.getData=function(){return{p:this.controlElements.p}},this.successHandler=function(e){try{const t=new r(function(e,t,r){try{var n=e.substring(0,e.length-32),s=e.substring(e.length-32);const i=forge.cipher.createDecipher("AES-GCM",forge.util.hexToBytes(t));if(i.start({iv:forge.util.hexToBytes(r),tagLength:128,tag:forge.util.hexToBytes(s)}),i.update(forge.util.createBuffer(forge.util.hexToBytes(n))),!i.finish())throw"Échec du déchiffrement.";try{return JSON.parse(i.output.toString().split("#")[0])}catch(e){return{}}}catch(e){throw"Échec du déchiffrement. Assurez-vous d’avoir collé les éléments de contrôle sans modification."}}(this.controlElements.c,this.controlElements.k,this.controlElements.i),e);e.voteLabel?this.el.innerHTML=this.renderHeader(e)+'<div class="alert alert-green text-center" role="alert"><i class="bi bi-check-circle-fill fs-5"></i> <span>Les éléments de contrôle donnés correspondent au bulletin ci-dessous.</span></div>'+t.render()+this.renderFooter():d("Les données retournées par le serveur sont incorrectes.Si le problème persiste, contactez le support technique.")}catch(e){d(e)}}}function u(e){t.call(this,e),this.path="/ballot-papers/control-presence",this.getData=function(){return{p:this.controlElements.p,f:this.controlElements.f}},this.successHandler=function(e){e.b===this.controlElements.b?this.el.innerHTML=this.renderHeader(e)+'<div class="alert alert-green text-center" role="alert"><i class="bi bi-envelope-check-fill fs-5"></i> <span>Votre bulletin est bien présent dans l’urne et n’a pas été modifié.</span></div><div class="card text-center"><div class="card-header">Valeur du bulletin chiffré dans l’urne</div><div class="card-body"><pre>'+e.b+"</pre></div></div>"+this.renderFooter():d("Le bulletin chiffré fourni ne correspond pas à l’empreinte associée. Assurez-vous d’avoir collé les éléments de contrôle sans modification. Si le problème persiste, contactez le support technique.")}}function d(e){const t=document.querySelector("[data-error-panel]");t?(t.querySelector("span").textContent=e,t.classList.remove("d-none")):alert(e)}function r(i,e){var n,l,t,r,s;if("object"!=typeof e)throw"La réponse du serveur est incorrecte. Contactez le support technique.";var o=i;if(n=e.candidates||null,l=e.questions||null,t=e.questionsApprovalLabel||null,r=e.questionsRefusalLabel||null,s=!1,0===Object.keys(o).length)throw"Le bulletin est vide et sera comptabilisé comme un nul.";if(delete o.userCategoryId,delete o.pollingStationId,!(s="blank"===o[0])){const a=n||l;Object.keys(o).forEach(function(e){if(!a[e])throw"Le bulletin est invalide et sera comptabilisé comme un nul."})}this.render=function(){return'<div class="card text-center"><div class="card-header">'+function(){if(s)return"Bulletin";var e=n||l;return e[Object.keys(i)[0]].ballotPaperTitle||"Bulletin"}()+'</div><ul class="list-group list-group-flush">'+(s?'<li class="list-group-item">Blanc</li>':(n?function(){var r="";const e=Object.keys(i);return e.forEach(function(e){var t=n[e],e=1===i[e];r=(r=(r=r+'<li class="list-group-item">'+(e?'<i class="bi bi-check-square text-green"></i> ':'<i class="bi bi-x-square text-danger"></i> <s>'))+t.firstName+" "+t.lastName)+(e?"":"</s>")+"</li>"}),r}:function(){var n="";const s={yes:{label:t,icon:"bi-check-square text-green"},no:{label:r,icon:"bi-x-square text-danger"},abstention:{label:"Abstention",icon:"bi-slash-square text-primary"},blank:{label:"Blanc",icon:"bi-square"}},e=Object.keys(i);return e.forEach(function(e){var t=l[e],e=i[e],r=void 0!==s[e]?s[e].label:"Nul",e=void 0!==s[e]?s[e].icon:"bi-exclamation-square text-danger";n=(n=(n+='<li class="list-group-item text-start d-flex">')+'<span class="flex-grow-1">'+t.position+" - "+t.label+"</span>")+'<i class="bi '+e+'" aria-label="'+r+'" title="'+r+'"></i> </li>'}),n})())+"</ul></div>"}}return(c.prototype=Object.create(t.prototype)).constructor=c,(u.prototype=Object.create(t.prototype)).constructor=u,{start:function(){const a=document.getElementById("control-form");a.addEventListener("submit",function(e){try{e.preventDefault();const n=function(e){switch(e.dataset.controlType){case"integrity":return new c(e);case"presence":return new u(e);default:d("Erreur de configuration du formulaire.")}}(a);{var t=n.getUrl();var r={data:n.getData(),successHandler:function(e){n.successHandler(e)}};const s=(r=r||{}).method||"POST",i=r.data||{},l=r.successHandler||null,o=new XMLHttpRequest;o.onreadystatechange=function(){if(o.readyState===XMLHttpRequest.DONE)if(200===o.status){if("function"==typeof l)try{var e=JSON.parse(o.responseText);l(e)}catch(e){d("Erreur. La réponse du serveur est incorrecte.")}}else try{d(JSON.parse(o.responseText).error)}catch(e){d("Erreur. La réponse du serveur est incorrecte. Statut "+o.status)}},o.open(s,t),o.setRequestHeader("Content-Type","application/json"),o.timeout=6e4,o.ontimeout=function(){d("Impossible de joindre le serveur.")},o.send(JSON.stringify(i))}}catch(e){e instanceof SyntaxError?d("Les éléments de contrôle fournis sont mal formatés. Assurez-vous de les avoir collés sans modification."):d('Erreur inconnue. Contactez le support technique si elle se reproduit avec le détail suivant : "'+e+'"')}})}}}();App.start();